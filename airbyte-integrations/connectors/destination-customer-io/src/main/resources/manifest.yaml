checker:
  type: HttpRequestChecker
  requester:
    type: HttpRequester
    url: https://track.customer.io/api/v1/accounts/region
    method: GET
    authenticator:
      type: BasicAccessAuthenticator
      username: '{{ config["credentials"]["siteId"] }}'
      password: '{{ config["credentials"]["apiKey"] }}'
writers:
  - type: BatchRequestWriter
    objects:
      - name: person_identify
        operation:
          type: Upsert
    rejected_records:
      type: BatchIndexRejectedRecords
      condition: "{{ response.status_code == 207 }}"
      rejections_field: ["errors"]
      index_field: ["batch_index"]
      fields_to_report:
        - - reason
        - - field
        - - message
    requester:
      type: HttpRequester
      url: https://track.customer.io/api/v2/batch
      method: POST
      headers:
        Content-Type: application/json
      authenticator:
        type: BasicAccessAuthenticator
        username: '{{ config["credentials"]["siteId"] }}'
        password: '{{ config["credentials"]["apiKey"] }}'
      body:
        type: JsonBatchBody
        size:
          type: RequestMemoryBatchSize
          # the limit is 500kb with 32kb per entry so here is 500kb - 32 kb
          limit: 468000
        entries:
          field:
            - batch
          content: |
            {
               "type": "person",
               "identifiers": {
                 "email": "{{ record["person_email"] }}"
               },
               "action": "identify"
               {{ additional_properties.isEmpty() ? '' : ', "attributes":' + additional_properties }}
            }
  - type: BatchRequestWriter
    objects:
      - name: person_event
        operation:
          type: Insert
    rejected_records:
      type: BatchIndexRejectedRecords
      condition: "{{ response.status_code == 207 }}"
      rejections_field: ["errors"]
      index_field: ["batch_index"]
      fields_to_report:
        - - reason
        - - field
        - - message
    requester:
      type: HttpRequester
      url: https://track.customer.io/api/v2/batch
      method: POST
      headers:
        Content-Type: application/json
      authenticator:
        type: BasicAccessAuthenticator
        username: '{{ config["credentials"]["siteId"] }}'
        password: '{{ config["credentials"]["apiKey"] }}'
      body:
        type: JsonBatchBody
        size:
          type: RequestMemoryBatchSize
          # the limit is 500kb with 32kb per entry so here is 500kb - 32 kb
          limit: 468000
        entries:
          field:
            - batch
          content: |
            {
               "type": "person",
               "identifiers": {
                 "email": "{{ record["person_email"] }}"
               },
               "action": "event",
               "name": "{{ record["event_name"] }}"
               {{ additional_properties.isEmpty() ? '' : ', "attributes":' + additional_properties }}
            }

spec:
  connection_specification:
    "$schema": http://json-schema.org/draft-07/schema#
    title: Customer Io Specification
    type: object
    additionalProperties: true
    properties:
      credentials:
        description: Enter the site ID and API key to authenticate.
        title: Credentials
        order: 0
        type: object
        additionalProperties: true
        properties:
          siteId:
            type: string
            description:
              Enter your Customer IO <a href="https://docs.customer.io/integrations/sdk/ios/getting-started/auth/#get-your-api-key">Site
              ID</a>.
            title: Site ID
            airbyte_secret: true
            always_show: true
            order: 1
          apiKey:
            type: string
            description:
              Enter your Customer IO <a href="https://docs.customer.io/integrations/sdk/ios/getting-started/auth/#get-your-api-key">API
              Key</a>.
            title: API Key
            airbyte_secret: true
            always_show: true
            order: 2
        required:
          - siteId
          - apiKey
    required:
      - credentials
discover:
  type: CompositeCatalogOperations
  operations:
    - type: StaticCatalogOperation
      object_name: person_identify
      destination_import_mode:
        type: Upsert
      schema:
        type: object
        required:
          - person_email
        additionalProperties: true
        properties:
          person_email:
            type: string
    - type: StaticCatalogOperation
      object_name: person_event
      destination_import_mode:
        type: Insert
      schema:
        type: object
        required:
          - person_email
          - event_name
        additionalProperties: true
        properties:
          person_email:
            type: string
          event_name:
            type: string
          event_id:
            type: string
          timestamp:
            type: integer
